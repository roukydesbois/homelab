apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - nextcloud-config-sc.yaml
  - nextcloud-config-sealed.yaml
  - nextcloud-data-pvc.yaml
  - psql-pvc.yaml
  - ../../base
  - nextcloud-ingress.yaml

patches:
  - patch: |-
      - op: add
        path: /spec/source/helm
        value:
          valuesObject:
            ingress:
              enabled: false
              className: tailscale
            nextcloud:
              host: nextcloud.tail9a43.ts.net
              existingSecret:
                enabled: true
                secretName: nextcloud-config
                usernameKey: username
                passwordKey: password
            internalDatabase:
              enabled: false
            externalDatabase:
              type: postgresql
              enabled: true
              host: nextcloud-helm-chart-postgresql
              port: 5432
              database: nextcloud
              user: nextcloud
              existingSecret:
                enabled: true
                secretName: nextcloud-config
                password-key: plsql-user-password
            postgresql:
              enabled: true
              global:
                postgresql:
                  auth:
                    existingSecret: nextcloud-config
                    secretKeys:
                      adminPasswordKey: psql-admin-password
                      userPasswordKey: psql-user-password
                      replicationPasswordKey: psql-replication-password
              primary:
                persistence:
                  enabled: true
                  existingClaim: psql-pvc
            persistence:
              enabled: true
              storageClass: nextcloud-config
              size: 8Gi
              nextcloudData:
                enabled: true
                existingClaim: nextcloud-data
    target:
      group: argoproj.io
      version: v1alpha1
      kind: Application
      name: nextcloud-helm-chart
      namespace: nextcloud
