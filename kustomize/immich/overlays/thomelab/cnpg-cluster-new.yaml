apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: immich-database
spec:
  instances: 3

  # imageName will be patched via kustomization

  storage:
    size: 8Gi
    storageClass: cnpg-storage-class
  postgresql:
    shared_preload_libraries:
      - "vchord.so"
    enableAlterSystem: true

  startDelay: 30
  stopDelay: 100

  # Bootstrap from existing immich-pg cluster using pg_basebackup
  bootstrap:
    pg_basebackup:
      source: immich-pg-source

  # Reference to source cluster for bootstrap
  externalClusters:
    - name: immich-pg-source
      connectionParameters:
        host: immich-pg-rw
        user: immich
        dbname: immich
      password:
        name: immich-pg-app
        key: password
