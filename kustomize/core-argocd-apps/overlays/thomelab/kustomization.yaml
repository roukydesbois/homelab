apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - minio-creds-sealed-secret.yaml
  - sealed-tailscale-oauth.yaml
  - ../../base

patches:
  - patch: |-
      - op: add
        path: /spec/source/helm/valuesObject/ingress
        value:
          enabled: true
          ingressClassName: tailscale
          host: thomelab-longhorn
          tls: true
      - op: add
        path: /spec/source/helm/valuesObject/defaultBackupStore
        value:
          backupTarget: s3://longhorn-backup@us-west-1/
          backupTargetCredentialSecret: minio-creds
    target:
      group: argoproj.io
      version: v1alpha1
      kind: Application
      name: longhorn
      namespace: argocd
  - patch: |-
      - op: add
        path: /spec/source/helm/valuesObject/operatorConfig
        value:
          hostname: thomelab-operator
    target:
      group: argoproj.io
      version: v1alpha1
      kind: Application
      name: tailscale-operator
      namespace: argocd
  - patch: |-
      - op: add
        path: /spec/source/helm
        value:
          valuesObject:
            global:
              domain: thomelab-argocd.tail9a43.ts.net
      - op: add
        path: /spec/source/helm/valuesObject/configs
        value:
          params:
            server.insecure: true
      - op: add
        path: /spec/source/helm/valuesObject/server
        value:
          ingress:
            enabled: true
            ingressClassName: tailscale
            hostname: thomelab-argocd
            extraTls:
              - hosts:
                - thomelab-argocd
    target:
      group: argoproj.io
      version: v1alpha1
      kind: Application
      name: argocd
      namespace: argocd
